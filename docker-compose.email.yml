##
## Docker Compose for Oxy Email Worker
##
## Runs the SMTP server + Rspamd spam filter on a DigitalOcean Droplet.
## The main API stays on App Platform — they share the same MongoDB.
##
## Usage:
##   docker compose -f docker-compose.email.yml up -d
##   docker compose -f docker-compose.email.yml logs -f email-worker
##

services:
  email-worker:
    build:
      context: .
      dockerfile: Dockerfile.email
    container_name: oxy-email-worker
    restart: unless-stopped
    ports:
      - "25:25"      # SMTP inbound (receiving mail from the internet)
      - "587:587"    # SMTP submission (STARTTLS)
    env_file:
      - .env.email
    environment:
      - SMTP_ENABLED=true
      - RSPAMD_URL=http://rspamd:11333
      - SPAM_FILTER_ENABLED=true
    depends_on:
      rspamd:
        condition: service_started
    networks:
      - email-net

  rspamd:
    image: rspamd/rspamd:latest
    container_name: oxy-rspamd
    restart: unless-stopped
    # Only expose to the internal network (email-worker accesses via http://rspamd:11333)
    # Port 11334 is the web UI — expose only on localhost for admin access
    ports:
      - "127.0.0.1:11334:11334"
    volumes:
      - rspamd-data:/var/lib/rspamd
    networks:
      - email-net

volumes:
  rspamd-data:

networks:
  email-net:
    driver: bridge
